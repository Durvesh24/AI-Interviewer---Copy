<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Interviewer</title>
    <link rel="stylesheet" href="style.css">
    <!-- Shared CSS only -->
    <style>
        /* Minimal layout override */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* Admin Tabs */
        .admin-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            font-weight: 600;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        /* User Table */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .user-table th,
        .user-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--card-border);
        }

        .user-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-color);
        }

        .action-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.4);
        }


        .btn-delete-interview {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 6px 12px;
            font-size: 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-delete-interview:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        /* User Email Link */
        .user-email-link {
            color: var(--secondary-color);
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .user-email-link:hover {
            color: var(--primary-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--card-border);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--primary-color);
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">AI Interview Coach</a>
            <div class="nav-links">
                <span id="user-display" style="margin-right: 15px; font-weight: 500;"></span>
                <a href="#" onclick="logout()" class="logout-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <header class="dashboard-header">
            <div class="welcome-text">
                <h1>My Dashboard</h1>
                <p>Track your interview performance</p>
            </div>
            <a href="mock-interview.html" class="btn btn-primary" style="width: auto;">+ Start New Interview</a>
        </header>

        <section id="admin-section" class="hidden">
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('interviews')">All Interviews</button>
                <button class="tab-btn" onclick="switchTab('users')">User Management</button>
            </div>
        </section>

        <!-- Interviews Tab -->
        <section id="interviews-view">
            <div class="interview-list-header">
                <h3>Past Interviews</h3>
            </div>
            <div id="interview-list">
                <div class="empty-state">Loading interviews...</div>
            </div>
        </section>

        <!-- User Management Tab (Admin Only) -->
        <section id="users-view" class="hidden">
            <div class="interview-list-header">
                <h3>Manage Users</h3>
            </div>
            <div id="user-list">
                <!-- User Table will go here -->
                <div class="empty-state">Loading users...</div>
            </div>
        </section>
    </div>

    <!-- User Interview Modal -->
    <div id="userInterviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalUserEmail">User Interviews</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div id="modalInterviewList">
                <div class="empty-state">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('userRole');
        const getApiBaseUrl = () => {
            const h = window.location.hostname;
            const p = window.location.protocol;
            if (p === 'file:' || h === 'localhost' || h === '127.0.0.1' || h.startsWith('192.168.')) {
                return 'http://localhost:5000';
            }
            return '';
        };
        const API_BASE_URL = getApiBaseUrl();


        if (!token) window.location.href = 'login.html';

        document.getElementById('user-display').innerText = localStorage.getItem('userEmail') || 'User';

        // Setup Admin View
        if (role === 'admin') {
            document.querySelector('.welcome-text h1').innerText = "Admin Control Center";
            document.querySelector('.welcome-text h1').style.background = "linear-gradient(to right, #ec4899, #8b5cf6)";
            document.querySelector('.welcome-text h1').style.webkitBackgroundClip = "text";
            document.querySelector('.welcome-text h1').style.webkitTextFillColor = "transparent";

            document.querySelector('.welcome-text p').innerText = "Manage users and oversee all interview performance";
            document.querySelector('.welcome-text p').style.color = "#d1d5db";

            document.getElementById('admin-section').classList.remove('hidden');
        }

        async function fetchInterviews() {
            try {
                const endpoint = role === 'admin' ? `${API_BASE_URL}/admin/all-interviews` : `${API_BASE_URL}/my-interviews`;
                const res = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${token}` } });

                if (res.status === 401 || res.status === 403) return logout();

                const data = await res.json();
                const list = document.getElementById('interview-list');

                if (data.length === 0) {
                    list.innerHTML = `<div class="empty-state"><p>No interviews found yet.</p></div>`;
                    return;
                }

                list.innerHTML = data.map(interview => {
                    const date = new Date(interview.date).toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const avgScore = interview.scores.length
                        ? (interview.scores.reduce((a, b) => a + b, 0) / interview.scores.length).toFixed(1) : 0;

                    let badgeClass = avgScore >= 7 ? 'high' : (avgScore >= 5 ? '' : 'low');

                    // Make user email clickable for admins
                    const userLabel = role === 'admin' && interview.email
                        ? `<div style="font-size:0.8rem; margin-bottom:4px;">
                             <span class="user-email-link" onclick="viewUserInterviews(${interview.user_id || 0}, '${interview.email}')">${interview.email}</span>
                           </div>` : '';

                    // Add delete button for admins
                    const deleteBtn = role === 'admin'
                        ? `<button class="btn-delete-interview" onclick="deleteInterview('${interview.id}')">Delete</button>` : '';

                    return `
                        <div class="interview-card" style="display: flex; justify-content: space-between; align-items: center; position: relative;">
                            <div style="flex: 1;">
                                ${userLabel}
                                <div class="interview-role">${interview.role}</div>
                                <div class="interview-date">${date}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="score-badge ${badgeClass}">Avg Score: ${avgScore} / 10</div>
                                ${deleteBtn}
                            </div>
                        </div>`;
                }).join('');
            } catch (err) {
                console.error(err);
                document.getElementById('interview-list').innerHTML = '<div class="empty-state">Failed to load.</div>';
            }
        }

        async function fetchUsers() {
            if (role !== 'admin') return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await res.json();

                const list = document.getElementById('user-list');
                if (users.length === 0) return list.innerHTML = '<div class="empty-state">No users found.</div>';

                let html = `
                    <table class="user-table">
                        <thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
                        <tbody>
                `;

                html += users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>
                            <button onclick="editUser(${user.id}, '${user.role}')" class="btn action-btn btn-edit">Edit</button>
                            <button onclick="deleteUser(${user.id})" class="btn action-btn btn-delete">Delete</button>
                        </td>
                    </tr>
                `).join('');

                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (err) {
                console.error(err);
                document.getElementById('user-list').innerHTML = '<div class="empty-state">Failed to load users.</div>';
            }
        }

        async function deleteUser(id) {
            if (!confirm("Are you sure? This will delete the user and all their data permanently.")) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) fetchUsers(); // Refresh list
                else alert("Failed to delete user");
            } catch (e) { alert("Error deleting user"); }
        }

        async function editUser(id, currentRole) {
            const newRole = prompt("Enter new role (user/admin):", currentRole);
            if (!newRole || newRole === currentRole) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                });
                if (res.ok) fetchUsers();
                else alert("Failed to update user");
            } catch (e) { alert("Error updating user"); }
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'interviews') {
                document.getElementById('interviews-view').classList.remove('hidden');
                document.getElementById('users-view').classList.add('hidden');
            } else {
                document.getElementById('interviews-view').classList.add('hidden');
                document.getElementById('users-view').classList.remove('hidden');
                fetchUsers();
            }
        }

        async function deleteInterview(interviewId) {
            if (!confirm("Are you sure you want to delete this interview? This action cannot be undone.")) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/interviews/${interviewId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    fetchInterviews(); // Refresh the list
                } else {
                    alert("Failed to delete interview");
                }
            } catch (e) {
                console.error(e);
                alert("Error deleting interview");
            }
        }

        async function viewUserInterviews(userId, userEmail) {
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${userId}/interviews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    alert("Failed to load user interviews");
                    return;
                }

                const data = await res.json();
                const modal = document.getElementById('userInterviewModal');
                const modalTitle = document.getElementById('modalUserEmail');
                const modalList = document.getElementById('modalInterviewList');

                modalTitle.innerText = `Interviews for ${userEmail}`;

                if (data.interviews.length === 0) {
                    modalList.innerHTML = '<div class="empty-state">No interviews found for this user.</div>';
                } else {
                    modalList.innerHTML = data.interviews.map(interview => {
                        const date = new Date(interview.date).toLocaleDateString(undefined, {
                            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        const avgScore = interview.scores.length
                            ? (interview.scores.reduce((a, b) => a + b, 0) / interview.scores.length).toFixed(1) : 0;
                        let badgeClass = avgScore >= 7 ? 'high' : (avgScore >= 5 ? '' : 'low');

                        return `
                            <div class="interview-card" style="display: flex; justify-content: space-between; align-items: center; position: relative;">
                                <div style="flex: 1;">
                                    <div class="interview-role">${interview.role}</div>
                                    <div class="interview-date">${date}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="score-badge ${badgeClass}">Avg Score: ${avgScore} / 10</div>
                                    <button class="btn-delete-interview" onclick="deleteInterview('${interview.id}')">Delete</button>
                                </div>
                            </div>`;
                    }).join('');
                }

                modal.classList.add('active');
            } catch (e) {
                console.error(e);
                alert("Error loading user interviews");
            }
        }

        function closeUserModal() {
            document.getElementById('userInterviewModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('userInterviewModal').addEventListener('click', function (e) {
            if (e.target === this) closeUserModal();
        });

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        fetchInterviews();
    </script>
</body>

</html>