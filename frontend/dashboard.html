<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AI Interviewer</title>
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Shared CSS only -->
    <style>
        /* Minimal layout override */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* Admin Tabs */
        .admin-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
            padding: 5px 10px;
            font-weight: 600;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        /* User Table */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .user-table th,
        .user-table td {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--card-border);
        }

        .user-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-color);
        }

        .action-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.4);
        }


        .btn-delete-interview {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 6px 12px;
            font-size: 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-delete-interview:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        /* User Email Link */
        .user-email-link {
            color: var(--secondary-color);
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .user-email-link:hover {
            color: var(--primary-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius);
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--card-border);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--primary-color);
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">AI Interview Coach</a>
            <div class="nav-links">
                <span id="user-display" style="margin-right: 15px; font-weight: 500;"></span>
                <a href="#" onclick="logout()" class="logout-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <header class="dashboard-header">
            <div class="welcome-text">
                <h1>My Dashboard</h1>
                <p>Track your interview performance</p>
            </div>
            <a href="mock-interview.html" id="startInterviewBtn" class="btn btn-primary" style="width: auto;">+ Start
                New Interview</a>
        </header>

        <section id="admin-section" class="hidden">
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('interviews')">Past Interviews</button>
                <button id="admin-analytics-tab" class="tab-btn" onclick="switchTab('performance')">Performance
                    Analytics</button>
                <button id="admin-tab-btn" class="tab-btn hidden" onclick="switchTab('users')">User Management</button>
            </div>
        </section>

        <!-- Interviews Tab -->
        <section id="interviews-view">
            <div class="interview-list-header">
                <h3>Past Interviews</h3>
            </div>
            <div id="interview-list">
                <div class="empty-state">Loading interviews...</div>
            </div>
        </section>

        <!-- Performance Tab -->
        <section id="performance-view" class="hidden">
            <div class="interview-list-header">
                <h3>Performance Analytics</h3>
            </div>
            <div class="card"
                style="background: var(--card-bg); padding: 20px; border-radius: var(--radius); border: 1px solid var(--card-border);">
                <canvas id="performanceChart"></canvas>
            </div>
        </section>

        <!-- User Management Tab (Admin Only) -->
        <section id="users-view" class="hidden">
            <div class="interview-list-header">
                <h3>Manage Users</h3>
            </div>
            <div id="user-list">
                <!-- User Table will go here -->
                <div class="empty-state">Loading users...</div>
            </div>
        </section>
    </div>

    <!-- User Interview Modal -->
    <div id="userInterviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalUserEmail">User Interviews</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div id="modalInterviewList">
                <div class="empty-state">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Interview Details Modal -->
    <div id="interviewDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Interview Details</h2>
                <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div id="detailsContent">
                <!-- Q&A will be injected here -->
            </div>
        </div>
    </div>

    <!-- User Performance Modal -->
    <div id="userPerformanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="perfModalTitle">User Performance</h2>
                <button class="modal-close" onclick="closeUserPerformanceModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <canvas id="modalPerformanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Change Role Modal -->
    <div id="changeRoleModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="roleModalTitle">Change User Role</h2>
                <button class="modal-close" onclick="closeRoleModal()">&times;</button>
            </div>
            <p id="roleModalUserText" style="margin-bottom: 15px;"></p>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="confirmRoleChange('user')">Make Learner</button>
                <button class="btn btn-secondary" onclick="confirmRoleChange('admin')">Make Admin</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('userRole');
        const getApiBaseUrl = () => {
            const h = window.location.hostname;
            const p = window.location.protocol;
            if (p === 'file:' || h === 'localhost' || h === '127.0.0.1' || h.startsWith('192.168.')) {
                return 'http://localhost:5000';
            }
            return '';
        };
        const API_BASE_URL = getApiBaseUrl();


        if (!token) window.location.href = 'login.html';

        document.getElementById('user-display').innerText = localStorage.getItem('userEmail') || 'User';

        // Setup Admin View
        if (role === 'admin') {
            document.querySelector('.welcome-text h1').innerText = "Admin Control Center";
            document.querySelector('.welcome-text h1').style.background = "linear-gradient(to right, #ec4899, #8b5cf6)";
            document.querySelector('.welcome-text h1').style.webkitBackgroundClip = "text";
            document.querySelector('.welcome-text h1').style.webkitTextFillColor = "transparent";

            document.querySelector('.welcome-text p').innerText = "Manage users and oversee all interview performance";
            document.querySelector('.welcome-text p').style.color = "#d1d5db";

            document.getElementById('admin-section').classList.remove('hidden');
            document.getElementById('admin-tab-btn').classList.remove('hidden');

            // Hide the Start Interview button for admins
            document.getElementById('startInterviewBtn').style.display = 'none';
            // Hide separate performance tab for admins (accessed via Users now)
            document.getElementById('admin-analytics-tab').style.display = 'none';
        }

        async function fetchInterviews() {
            try {
                const endpoint = role === 'admin' ? `${API_BASE_URL}/admin/all-interviews` : `${API_BASE_URL}/my-interviews`;
                const res = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${token}` } });

                if (res.status === 401 || res.status === 403) return logout();

                const data = await res.json();
                const list = document.getElementById('interview-list');

                if (data.length === 0) {
                    list.innerHTML = `<div class="empty-state"><p>No interviews found yet.</p></div>`;
                    return;
                }

                list.innerHTML = data.map(interview => {
                    const date = new Date(interview.date).toLocaleDateString(undefined, {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const avgScore = interview.scores.length
                        ? (interview.scores.reduce((a, b) => a + b, 0) / interview.scores.length).toFixed(1) : 0;

                    let badgeClass = avgScore >= 7 ? 'high' : (avgScore >= 5 ? '' : 'low');

                    // Make user email clickable for admins
                    const userLabel = role === 'admin' && interview.email
                        ? `<div style="font-size:0.8rem; margin-bottom:4px;">
                             <span class="user-email-link" onclick="viewUserInterviews(${interview.user_id || 0}, '${interview.email}')">${interview.email}</span>
                           </div>` : '';

                    // Add delete button for admins
                    const deleteBtn = role === 'admin'
                        ? `<button class="btn-delete-interview" onclick="deleteInterview('${interview.id}')">Delete</button>` : '';

                    // Add retake button only for regular users
                    const retakeBtn = role !== 'admin'
                        ? `<button class="btn-retake btn-edit" data-role="${interview.role}" data-questions='${JSON.stringify(interview.questions)}' style="padding: 6px 12px; border:none; border-radius:6px; cursor:pointer; background:rgba(16, 185, 129, 0.2); color:#6ee7b7;">Retake</button>`
                        : '';

                    return `
                        <div class="interview-card" style="display: flex; justify-content: space-between; align-items: center; position: relative;">
                            <div style="flex: 1;">
                                ${userLabel}
                                <div class="interview-role">${interview.role}</div>
                                <div class="interview-date">${date}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="score-badge ${badgeClass}">Avg Score: ${avgScore} / 10</div>
                                <button class="btn-edit" style="padding: 6px 12px; border:none; border-radius:6px; cursor:pointer;" onclick="viewInterviewDetails('${interview.id}')">View</button>
                                ${retakeBtn}
                                ${deleteBtn}
                            </div>
                        </div>`;
                }).join('');

                // Add event listeners to retake buttons
                setTimeout(() => {
                    document.querySelectorAll('.btn-retake').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const role = btn.getAttribute('data-role');
                            const questions = JSON.parse(btn.getAttribute('data-questions'));
                            retakeInterview(role, questions);
                        });
                    });
                }, 0);
            } catch (err) {
                console.error(err);
                document.getElementById('interview-list').innerHTML = '<div class="empty-state">Failed to load.</div>';
            }
        }

        async function fetchUsers() {
            if (role !== 'admin') return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await res.json();

                const list = document.getElementById('user-list');
                if (users.length === 0) return list.innerHTML = '<div class="empty-state">No users found.</div>';

                let html = `
                    <table class="user-table">
                        <thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
                        <tbody>
                `;

                html += users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>
                            <a href="admin-user-details.html?id=${user.id}" style="color: var(--secondary-color); text-decoration: none; font-weight: 500;">
                                ${user.email}
                            </a>
                        </td>
                        <td>${user.role === 'user' ? 'Learner' : 'Admin'}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <a href="admin-user-details.html?id=${user.id}" class="btn action-btn btn-edit" style="text-decoration:none;">View</a>
                            </div>
                        </td>
                    </tr>
                `).join('');

                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (err) {
                console.error(err);
                document.getElementById('user-list').innerHTML = '<div class="empty-state">Failed to load users.</div>';
            }
        }


        // --- Admin Action Handlers ---

        function handleUserAction(selectElem, userId, currentRole, userEmail) {
            const action = selectElem.value;
            selectElem.value = ""; // Reset dropdown

            if (action === 'delete') {
                deleteUser(userId);
            } else if (action === 'performance') {
                showUserPerformance(userId, userEmail);
            } else if (action === 'change_role') {
                openRoleModal(userId, userEmail);
            }
        }

        async function deleteUser(id) {
            if (!confirm("Are you sure? This will delete the user and all their data permanently.")) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) fetchUsers(); // Refresh list
                else alert("Failed to delete user");
            } catch (e) { alert("Error deleting user"); }
        }

        let selectedUserIdForRole = null;
        function openRoleModal(id, email) {
            selectedUserIdForRole = id;
            document.getElementById('roleModalUserText').innerText = `Select new role for: ${email}`;
            document.getElementById('changeRoleModal').classList.add('active');
        }

        function closeRoleModal() {
            document.getElementById('changeRoleModal').classList.remove('active');
            selectedUserIdForRole = null;
        }

        async function confirmRoleChange(newRole) {
            if (!selectedUserIdForRole) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${selectedUserIdForRole}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                });
                if (res.ok) {
                    closeRoleModal();
                    fetchUsers();
                }
                else alert("Failed to update user");
            } catch (e) { alert("Error updating user"); }
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('interviews-view').classList.add('hidden');
            document.getElementById('users-view').classList.add('hidden');
            document.getElementById('performance-view').classList.add('hidden');

            if (tab === 'interviews') {
                document.getElementById('interviews-view').classList.remove('hidden');
            } else if (tab === 'performance') {
                document.getElementById('performance-view').classList.remove('hidden');
                if (role !== 'admin') renderAnalytics(); // Only render for non-admin on this tab
            } else {
                document.getElementById('users-view').classList.remove('hidden');
                fetchUsers();
            }
        }

        // --- Retake Logic ---
        function retakeInterview(role, questions) {
            // questions is already an array, no need to parse
            console.log("Retake called with role:", role, "questions:", questions);
            const dataToSave = { role, questions };
            console.log("Saving to localStorage:", dataToSave);
            localStorage.setItem('retakeData', JSON.stringify(dataToSave));
            window.location.href = 'mock-interview.html';
        }

        // --- Analytics Chart Logic ---

        // 1. User's Own Analytics (Performance Tab)
        // 2. Admin's Analytics for Specific User (Modal)

        let chartInstance = null; // For the main tab
        let modalChartInstance = null; // For the admin modal

        async function renderAnalytics() {
            // This function is now ONLY for the "Performance" tab, which is hidden for admins or used by learners
            if (role === 'admin') return;

            try {
                const res = await fetch(`${API_BASE_URL}/my-interviews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const interviews = await res.json();
                drawChart(interviews, 'performanceChart', 'Your Average Score');
            } catch (err) { console.error("Analytics Error:", err); }
        }

        async function showUserPerformance(userId, userEmail) {
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${userId}/interviews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json(); // { user, interviews }

                document.getElementById('perfModalTitle').innerText = `Performance: ${userEmail}`;
                document.getElementById('userPerformanceModal').classList.add('active');

                drawChart(data.interviews, 'modalPerformanceChart', `Average Score (${userEmail})`, true);

            } catch (e) { console.error(e); alert("Failed to load user performance"); }
        }

        function closeUserPerformanceModal() {
            document.getElementById('userPerformanceModal').classList.remove('active');
        }

        function drawChart(interviews, canvasId, label, isModal = false) {
            const sorted = interviews.sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sorted.map(i => new Date(i.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }));
            const scores = sorted.map(i => {
                const avg = i.scores.length ? (i.scores.reduce((a, b) => a + b, 0) / i.scores.length) : 0;
                return avg.toFixed(1);
            });

            const ctx = document.getElementById(canvasId).getContext('2d');

            let updateInstance = isModal ? modalChartInstance : chartInstance;
            if (updateInstance) updateInstance.destroy();

            const newChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: scores,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ec4899'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 10, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9ca3af' } },
                        x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
                    },
                    plugins: { legend: { labels: { color: '#e5e7eb' } } }
                }
            });

            if (isModal) modalChartInstance = newChart;
            else chartInstance = newChart;
        }

        async function deleteInterview(interviewId) {
            if (!confirm("Are you sure you want to delete this interview? This action cannot be undone.")) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/interviews/${interviewId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    fetchInterviews(); // Refresh the list
                } else {
                    alert("Failed to delete interview");
                }
            } catch (e) {
                console.error(e);
                alert("Error deleting interview");
            }
        }

        async function viewUserInterviews(userId, userEmail) {
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${userId}/interviews`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    alert("Failed to load user interviews");
                    return;
                }

                const data = await res.json();
                const modal = document.getElementById('userInterviewModal');
                const modalTitle = document.getElementById('modalUserEmail');
                const modalList = document.getElementById('modalInterviewList');

                modalTitle.innerText = `Interviews for ${userEmail}`;

                if (data.interviews.length === 0) {
                    modalList.innerHTML = '<div class="empty-state">No interviews found for this user.</div>';
                } else {
                    modalList.innerHTML = data.interviews.map(interview => {
                        const date = new Date(interview.date).toLocaleDateString(undefined, {
                            year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        const avgScore = interview.scores.length
                            ? (interview.scores.reduce((a, b) => a + b, 0) / interview.scores.length).toFixed(1) : 0;
                        let badgeClass = avgScore >= 7 ? 'high' : (avgScore >= 5 ? '' : 'low');

                        return `
                            <div class="interview-card" style="display: flex; justify-content: space-between; align-items: center; position: relative;">
                                <div style="flex: 1;">
                                    <div class="interview-role">${interview.role}</div>
                                    <div class="interview-date">${date}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="score-badge ${badgeClass}">Avg Score: ${avgScore} / 10</div>
                                    <button class="btn-delete-interview" onclick="deleteInterview('${interview.id}')">Delete</button>
                                </div>
                            </div>`;
                    }).join('');
                }

                modal.classList.add('active');
            } catch (e) {
                console.error(e);
                alert("Error loading user interviews");
            }
        }

        function closeUserModal() {
            document.getElementById('userInterviewModal').classList.remove('active');
        }

        // --- Interview Details Logic ---
        async function viewInterviewDetails(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/my-interviews/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    alert("Failed to load details");
                    return;
                }

                const data = await res.json();
                const modal = document.getElementById('interviewDetailsModal');
                const content = document.getElementById('detailsContent');

                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--primary-color);">${data.role}</h3>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            Date: ${new Date(data.date).toLocaleString()}
                        </p>
                    </div>
                `;

                if (data.questions && data.questions.length > 0) {
                    html += data.questions.map((q, index) => {
                        const answer = data.answers[index] || "No answer provided";
                        const score = data.scores[index] !== undefined ? data.scores[index] : "-";

                        // Color code score
                        let scoreColor = '#ef4444'; // red
                        if (score >= 7) scoreColor = '#10b981'; // green
                        else if (score >= 4) scoreColor = '#f59e0b'; // orange

                        return `
                            <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--card-border); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <div style="margin-bottom: 8px; font-weight: 600; color: #e5e7eb;">
                                    Q${index + 1}: ${q}
                                </div>
                                <div style="margin-bottom: 8px; color: #d1d5db; font-size: 0.95rem;">
                                    <strong style="color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase;">Your Answer:</strong><br>
                                    ${answer}
                                </div>
                                <div style="font-size: 0.9rem; font-weight: 600; color: ${scoreColor};">
                                    Score: ${score}/10
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    html += '<p>No questions recorded for this interview.</p>';
                }

                content.innerHTML = html;
                modal.classList.add('active');

            } catch (err) {
                console.error(err);
                alert("Error loading details");
            }
        }

        function closeDetailsModal() {
            document.getElementById('interviewDetailsModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('interviewDetailsModal').addEventListener('click', function (e) {
            if (e.target === this) closeDetailsModal();
        });

        // Close modal when clicking outside
        document.getElementById('userInterviewModal').addEventListener('click', function (e) {
            if (e.target === this) closeUserModal();
        });

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }

        fetchInterviews();
    </script>
</body>

</html>